{% load custom_tags %}
{% load static %}
<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet" href="{% static 'upload_ad.css' %}">

  <title>Upload Ad</title>
  <style>
    #loading {
      width: 100%;
      height: 100%;
      top: 0px;
      left: 0px;
      position: fixed;
      display: none;
      opacity: 0.7;
      background-color: #fff;
      z-index: 99;
      text-align: center;
    }

    #loading-image {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
      display: flex;
      flex-direction: column;
      justify-content: start;
      align-items: center;
    }
  </style>
</head>

<body>
  {% include 'app/navbar.html' %}
  <div class="container cont1">
    <h1 class="heading">Import file</h1>
    {% if page == 'image' %}
    <p class="leftpara">Step #5: Upload Image Ad File(s)</p>
    {% elif page == "video" %}
    <p class="leftpara">Step #4: Upload Video Ad File and Select Desired Video Frame</p>
    {% else %}
    {% endif %}
    <form class="d-flex" action="/home/{{page}}/" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="box1 shadow">
        <input type="hidden" name="Name" value="{{Name}}">
        <input type="hidden" name="CampaignUrl" value="{{CampaignUrl}}">
        {% if page == 'image' %}
        <p>Please upload the following sizes for image WxH:</p>
        <input type="hidden" name="mobiledevices" value="{{mobiledevices}}">
        <input type="hidden" name="desktopdevices" value="{{desktopdevices}}">
        <input type="hidden" name="CrawlUrl" id="frame">
        {% for j in obj %}
        <div class="row">
          <div class="col-12 col-sm-3">
            <label for="img">{{j.w}}x{{j.h}}</label>
          </div>
          <div class="col-sm-9 col-12">
            <input class="img-fluid imageone verify" type="file" id="{{j.w}}x{{j.h}}" name="AdFile" accept="image/*"
              onchange="imagevalidate('{{j.w}}x{{j.h}}')">
          </div>
        </div>
        <br>
        {% endfor %}
        {% elif page == "video" %}
        <input type="hidden" name="CrawlUrl" id="frame">
        <div class="row">
          
          <div class="col-12">
            <input class="img-fluid imageone verify" type="file" id="video" name="AdFile" accept="video/*" onchange="extractframes()" required>
          </div>
        </div>
        <br>
        {% else %}
        <input type="url" class="img-fluid imageone" name="CrawlUrl" placeholder="Paste Ad URL Here"
          style="border-color: black;">
        {% endif %}
        <div style="text-align: center; padding-bottom: 1rem;">
          <button class="btn button1" id="subbtn" onclick="progress()">Next</button>
        </div>
        <div id="loading">
          <div id="loading-image">
            <img src="http://cdn.nirmaltv.com/images/generatorphp-thumb.gif" alt="Loading..." />
            <span id="loadingmsg"></span>
          </div>
        </div>
      </div>
    </form>

    <div id="preview_image_thumbnail">
      <div class="ol_container">
        <p>Please Select Thumbnail for Video Ad</p>
        <ol id="olFrames" style="display: inline-block;"></ol>
      </div>
      <div class="image_preview" id="image_preview">
        <h3>Selected Thumbnail</h3>
        <img src="" alt="image_preview" id="my_image_preview">
      </div>
    </div>
  </div>
  <script type="text/JavaScript">
    function progress() {
      loading.style.display = "block";
      loadingmsg.innerHTML = "Please wait! It may take time to complete."
    }
    var cls =  document.getElementsByClassName("verify")
    window.addEventListener("load", ()=>{
      for (index = 0; index < cls.length; ++index) {
          cls[index].setAttribute("required","required");
      }
    });
    function imagevalidate(size){
      file = document.getElementById(size).files[0];
      var img = new Image();
      img.src = window.URL.createObjectURL( file );
      img.onload = function() {
        var width = img.naturalWidth, height = img.naturalHeight;
        if(!size.includes(width+"x"+height)){
          document.getElementById(size).value = ''
          console.log("("+width+"x"+height+") not valid");
          alert('Please upload given size file')
        }
        else{
          Array.prototype.forEach.call(cls, (item) => item.removeAttribute('required'));
        }
      }
    }
    document.getElementById('preview_image_thumbnail').style.display = 'none'
    document.getElementById('image_preview').style.display = 'none'
    var file;
    function getVideoImage(path, secs, callback) {

      var me = this, video = document.createElement('video');
      video.onloadedmetadata = function() {
        if ('function' === typeof secs) {
          secs = secs(this.duration);
        }
        this.currentTime = Math.min(Math.max(0, (secs < 0 ? this.duration : 0) + secs), this.duration);
      };
      video.onseeked = function(e) {
        var canvas = document.createElement('canvas');
        canvas.height = video.videoHeight;
        canvas.width = video.videoWidth;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        var img = new Image();
        img.src = canvas.toDataURL();
        
        callback.call(me, img, this.currentTime, e);
      };
      video.onerror = function(e) {
        callback.call(me, undefined, undefined, e);
      };
      video.src = path;   
    }
    function extractframes(){
      loading.style.display = "block";
      loadingmsg.innerHTML = "please wait! video frames are loading for selection"
      file = document.getElementById('video').files[0];
      showImageAt(1);
    }
    function showImageAt(secs) {
      document.getElementById('subbtn').style.display = "none";
      if(file.type.includes('video/')){
        var duration;
        getVideoImage(
        window.URL.createObjectURL(file),
        function(totalTime) {
          duration = totalTime;
          if(parseInt(duration) === secs){
            document.getElementById('subbtn').style.display = "block";
            loading.style.display = "none";
          }
          return secs;
        },
        function(img, secs, event) {
          if (event.type == 'seeked') {
            var li = document.createElement('li');
            li.appendChild(img);
            img.onload = function() {
              document.getElementById('preview_image_thumbnail').style.display = 'block'
            var width = img.naturalWidth, height = img.naturalHeight;
            // console.log(width, height);
            
            img.setAttribute('id', secs)
            li.addEventListener("click", (e)=>{
              document.getElementById('image_preview').style.display = 'block'
              document.getElementById('my_image_preview').src = e.target.src;
              document.getElementById('frame').value = secs;
            });
            document.getElementById('olFrames').appendChild(li);
            if (duration >= ++secs) {
              showImageAt(secs);
            };
          }
          }
        }
      );
    }
  }
  </script>
  <!-- Optional JavaScript; choose one of the two! -->

  <!-- Option 1: Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>

  <!-- Option 2: Separate Popper and Bootstrap JS -->
  <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    -->
  <!-- <div class="lastpart">All rights reserved 2022 by <a href="index">Piranhad</a>. Developed and maintained by <a
      href="https://fabtechsol.com/">Fabulous Technology Solutions</a>.</div> -->
  {% include 'app/footerAdmin.html' %}

</body>

</html>